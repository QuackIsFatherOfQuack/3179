{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Visits for each month from 2015 to 2024",
  "description": "Cycle plot: x = months (Janâ€“Dec), y = visitors; within each month, the line shows the trend over years; dark rule = month mean.",
  "width": 700,
  "height": 400,
  "data": { "url": "data/Viz5_data.csv" },
  "transform": [
    { "calculate": "timeParse(datum.Month, '%b-%Y')", "as": "Date" },
    { "calculate": "month(datum.Date)", "as": "MonthIdx" },          
    { "calculate": "year(datum.Date)", "as": "Year" },
    { "calculate": "timeFormat(datum.Date, '%b')", "as": "MonthName" },
    {
      "joinaggregate": [
        { "op": "min", "field": "Year", "as": "MinYear" },
        { "op": "max", "field": "Year", "as": "MaxYear" }
      ]
    },
    { "calculate": "(datum.Year - datum.MinYear) / max(1, (datum.MaxYear - datum.MinYear))", "as": "YearNorm" },

    { "calculate": "datum.MonthIdx + 0.1 + 0.8 * datum.YearNorm", "as": "Xpos" },

    { "calculate": "datum.MonthIdx + 0.1", "as": "Xleft" },
    { "calculate": "datum.MonthIdx + 0.9", "as": "Xright" }
  ],

  "layer": [
    {
      "mark": { "type": "line", "opacity": 0.7 },
      "encoding": {
        "x": {
          "field": "Xpos",
          "type": "quantitative",
          "scale": { "domain": [0, 12], "nice": false },
          "axis": {
            "values": [0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5,10.5,11.5],
            "labelExpr": "['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][round(datum.value-0.5)]",
            "title": "Month"
          }
        },
        "y": {
          "field": "TotalVisitorCount",
          "type": "quantitative",
          "axis": { "title": "Visitors", "format": "~s" }
        },
        "detail": { "field": "MonthName" },
        "color": { "value": "#2a9d8f" },
        "tooltip": [
          { "field": "MonthName", "title": "Month" },
          { "field": "Year", "title": "Year" },
          { "field": "TotalVisitorCount", "title": "Visitors", "format": "," }
        ]
      }
    },
    {
      "transform": [
        {
          "aggregate": [
            { "op": "mean", "field": "TotalVisitorCount", "as": "MonthMean" },
            { "op": "min", "field": "Xleft", "as": "Xl" },
            { "op": "max", "field": "Xright", "as": "Xr" }
          ],
          "groupby": ["MonthIdx","MonthName"]
        }
      ],
      "mark": { "type": "rule", "strokeWidth": 2, "color": "#1d3557" },
      "encoding": {
        "x": { "field": "Xl", "type": "quantitative" },
        "x2": { "field": "Xr" },
        "y": { "field": "MonthMean", "type": "quantitative" },
        "tooltip": [
          { "field": "MonthName", "title": "Month" },
          { "field": "MonthMean", "title": "Mean", "format": "," }
        ]
      }
    }
  ]
}
