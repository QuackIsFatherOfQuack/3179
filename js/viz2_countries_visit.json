{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Top 15 countries by total arrivals",
  "description": "Top 15 countries by total arrivals, excluding 'Total' country, showing share of global total.",
  "width": 700,
  "height": 400,
  "data": {"url": "data/citizenship_arrival.csv"},
  "transform": [
    {"filter": "datum.Country != 'Total'"},
    {"aggregate": [{"op": "sum", "field": "Value", "as": "Total_Value"}], "groupby": ["Country"]},
    {"joinaggregate": [{"op": "sum", "field": "Total_Value", "as": "GrandTotal"}]},
    {"calculate": "datum.Total_Value / datum.GrandTotal * 100", "as": "PercentOfTotal"},
    {"window": [{"op": "rank", "as": "Rank"}], "sort": [{"field": "Total_Value", "order": "descending"}]},
    {"filter": "datum.Rank <= 15"},
    {"calculate": "format(datum.PercentOfTotal, '.1f') + '%'", "as": "PercentLabel"}
  ],
  "layer": [
    {
      "mark": {"type": "bar", "cornerRadiusEnd": 4},
      "encoding": {
        "y": {"field": "Country", "type": "nominal", "sort": "-x", "axis": {"title": null}},
        "x": {"field": "PercentOfTotal", "type": "quantitative", "axis": {"title": "Share of Total (%)"}},
        "color": {"field": "PercentOfTotal", "type": "quantitative", "legend": null},
        "tooltip": [
          {"field": "Country", "type": "nominal"},
          {"field": "Total_Value", "type": "quantitative", "format": ","},
          {"field": "PercentOfTotal", "type": "quantitative", "format": ".2f"},
          {"field": "Rank", "type": "quantitative"}
        ]
      }
    },
    {
      "mark": {"type": "text", "align": "left", "dx": 5, "dy": 0, "fontSize": 12, "fontWeight": "bold"},
      "transform": [
        {"filter": "datum.Rank <= 5"}  
      ],
      "encoding": {
        "y": {"field": "Country", "type": "nominal", "sort": "-x"},
        "x": {"field": "PercentOfTotal", "type": "quantitative"},
        "text": {"field": "PercentLabel", "type": "nominal"}
      }
    }
  ],
  "config": {
    "view": {"stroke": "transparent"},
    "axis": {"labelFontSize": 12, "titleFontSize": 13}
  }
}
